import {
  JupyterFrontEnd,
  JupyterFrontEndPlugin
} from '@jupyterlab/application';
import { IEditorLanguageRegistry } from '@jupyterlab/codemirror';
import { LabIcon } from '@jupyterlab/ui-components';
import { StreamLanguage, LanguageSupport } from '@codemirror/language';
import { makefileSimple as makefile } from './makefile-mode-simple';

// Makefile icon - file with gears (from text-x-makefile-svgrepo-com.svg, simplified)
const makefileIconStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="23 11 82 106">
<path d="m29.09375,11.234375c-3.183804,0-5.71875,2.566196-5.71875,5.75l0,94.031255c0,3.1838 2.534946,5.75 5.71875,5.75l69.8125,0c3.1838,0 5.71875-2.5662 5.71875-5.75l0-70.656255-21.03125,0c-4.306108,0-8.0625-3.141109-8.0625-7.3125l0-21.8125-46.4375,0zm50.4375,0l0,21.8125c0,1.714122 1.631968,3.3125 4.0625,3.3125l21.03125,0-25.09375-25.125zm-32.34375,29.3125l1.71875,0 1.65625,3.5.03125.75-.53125,2.4375 3.25,1.3125 1.3125-2.0625.59375-.53125 3.59375-1.25 1.25,1.21875-1.28125,3.59375-.5.59375-2.0625,1.3125 1.3125,3.28125 2.40625-.5625.78125.03125 3.46875,1.65625 0,1.75-3.46875,1.65625-.78125,0-2.40625-.5-1.3125,3.21875 2.0625,1.375.5.59375 1.28125,3.59375-1.25,1.25-3.59375-1.28125-.59375-.5625-1.3125-2.0625-3.25,1.34375.53125,2.40625-.03125.78125-1.65625,3.4375-1.71875,0-1.65625-3.4375-.0625-.78125.53125-2.40625-3.25-1.34375-1.3125,2.0625-.59375.5625-3.59375,1.28125-1.25-1.25 1.28125-3.59375.5625-.59375 2.0625-1.375-1.34375-3.21875-2.40625.5-.8125,0-3.46875-1.65625 0-1.75 3.46875-1.65625.8125-.03125 2.40625.5625 1.34375-3.28125-2.0625-1.3125-.5625-.59375L36,45.921875l1.25-1.21875 3.59375,1.25.59375.53125 1.3125,2.0625 3.25-1.3125-.53125-2.4375.0625-.75 1.65625-3.5zm.875,10.875c-2.927972,0-5.34375,2.353278-5.34375,5.28125 0,2.927972 2.415778,5.3125 5.34375,5.3125 2.927972,0 5.28125-2.384528 5.28125-5.3125 0-2.927972-2.353278-5.28125-5.28125-5.28125zm18.15625,10.3125l3.09375,3.34375.46875,1.15625.40625,2.75 4.46875,0 .40625-2.75.4375-1.15625 3.125-3.34375 2.25.71875.53125,4.53125-.28125,1.21875-1.3125,2.4375 3.625,2.65625 1.90625-2 1.0625-.625 4.5-.90625 1.375,1.90625-2.21875,3.96875-.96875.8125-2.46875,1.1875 1.40625,4.28125 2.71875-.46875 1.21875.09375 4.15625,1.90625 0,2.34375-4.15625,1.9375-1.21875.09375-2.71875-.46875-1.40625,4.25 2.46875,1.21875.96875.78125 2.21875,4.03125-1.375,1.875-4.5-.875-1.0625-.65625-1.90625-2-3.625,2.65625 1.3125,2.406255.28125,1.21875-.53125,4.5625-2.25.75-3.125-3.40625-.4375-1.125-.40625-2.71875-4.46875,0-.40625,2.71875-.46875,1.125-3.09375,3.40625-2.25-.75-.53125-4.5625.3125-1.21875 1.28125-2.406255-3.625-2.65625-1.9375,2-1.0625.65625-4.46875.875-1.375-1.875 2.21875-4.03125.9375-.78125 2.46875-1.21875-1.34375-4.25-2.71875.46875-1.21875-.09375-4.1875-1.9375 0-2.34375 4.1875-1.90625 1.21875-.09375 2.71875.46875 1.34375-4.28125-2.46875-1.1875-.9375-.8125-2.21875-3.96875 1.375-1.90625 4.46875.90625 1.0625.625 1.9375,2 3.625-2.65625-1.28125-2.4375-.3125-1.21875.53125-4.53125 2.25-.71875zm6.1875,14.09375c-4.866236,0-8.8125,3.946264-8.8125,8.8125 0,4.866238 3.946264,8.8125 8.8125,8.8125 4.866237,0 8.8125-3.946262 8.8125-8.8125 0-4.866236-3.946263-8.8125-8.8125-8.8125z"/>
<path fill="#ff5555" d="m47.393586,61.929091c-2.577074-.341802-4.610823-2.657365-4.616697-5.256429-.0054-2.395832 1.810216-4.569536 4.243519-5.080415.81638-.171401 1.323805-.172915 2.109881-.0063 2.758059.584618 4.627798,3.403366 4.057323,6.11667-.571747,2.719355-3.123414,4.580675-5.794026,4.226467z"/>
<path fill="#ff5555" d="m71.276968,93.32916c-2.793603-.349232-5.395634-2.199923-6.672869-4.74607-.728384-1.452022-.981711-2.686005-.904752-4.40714.05683-1.270967.256018-2.109387.760584-3.201454 1.178269-2.550209 3.583251-4.421629 6.352861-4.943433 1.072474-.202058 2.760491-.144258 3.794645.129933 1.876622.49756 3.627063,1.671781 4.800702,3.220382.520231.686437 1.269432,2.21888 1.471294,3.009438 1.165032,4.562647-1.406455,9.19698-5.88673,10.609064-1.252696.394822-2.387211.49536-3.715735.32928z"/>
<path fill="#c2544f" d="m82.705539,36.233768c-.77286-.124429-1.77764-.656304-2.266029-1.199509-.506957-.563859-.703014-.962017-.817307-1.659814-.05098-.311256-.08782-5.038765-.08813-11.31007l-5.4e-4-10.775276 6.956385,6.950203c3.826012,3.822611 9.435826,9.458657 12.466252,12.524546l5.50986,5.574344-10.623681-.01091c-5.843027-.006-10.854589-.04808-11.136805-.09352z"/>
</svg>`;

export const makefileIcon = new LabIcon({
  name: 'makefile:icon',
  svgstr: makefileIconStr
});

/**
 * Initialization data for the jupyterlab_makefile_file_type_extension extension.
 */
const plugin: JupyterFrontEndPlugin<void> = {
  id: 'jupyterlab_makefile_file_type_extension:plugin',
  description:
    'Jupyterlab extension to add handling of Makefiles and syntax colouring support',
  autoStart: true,
  requires: [IEditorLanguageRegistry],
  activate: (app: JupyterFrontEnd, languages: IEditorLanguageRegistry) => {
    console.log(
      '[jupyterlab_makefile_file_type_extension v1.0.31-debug] Extension activated!'
    );

    // Register Makefile language support
    languages.addLanguage({
      name: 'makefile',
      displayName: 'Makefile',
      mime: 'text/x-makefile',
      extensions: ['.mk', '.mak', '.make', '.makefile'],
      filename: /^(Makefile|makefile|GNUmakefile|makefile\..*|.*\.(mk|mak|make|makefile))$/,
      support: new LanguageSupport(StreamLanguage.define(makefile))
    });

    // Register icon for Makefile file type
    app.docRegistry.addFileType({
      name: 'makefile',
      displayName: 'Makefile',
      mimeTypes: ['text/x-makefile'],
      extensions: ['.mk', '.mak', '.make', '.makefile'],
      pattern: '^(Makefile|makefile|GNUmakefile|makefile\\..*|.*\\.(mk|mak|make|makefile))$',
      fileFormat: 'text' as const,
      contentType: 'file' as const,
      icon: makefileIcon
    });
  }
};

export default plugin;
